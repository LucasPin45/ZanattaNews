name: Telegram News Bot

on:
  schedule:
    # Not√≠cias a cada 15 minutos
    - cron: "*/15 * * * *"
    # Pauta da C√¢mara √†s 7h BRT (10h UTC)
    - cron: "0 10 * * 1-5"
    # Resumo di√°rio √†s 20h BRT (23h UTC)
    - cron: "0 23 * * *"
  workflow_dispatch:
    inputs:
      mode:
        description: 'Modo de execu√ß√£o'
        required: true
        default: 'normal'
        type: choice
        options:
          - normal
          - summary
          - pauta
      hours:
        description: 'Horas para buscar (s√≥ modo normal)'
        required: false
        default: '8'
        type: string

concurrency:
  group: newsbot
  cancel-in-progress: true

permissions:
  contents: write

jobs:
  run-bot:
    runs-on: ubuntu-latest
    timeout-minutes: 15

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"
          cache: 'pip'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: Determine run mode
        id: mode
        run: |
          if [[ "${{ github.event_name }}" == "workflow_dispatch" ]]; then
            echo "mode=${{ github.event.inputs.mode }}" >> $GITHUB_OUTPUT
            echo "hours=${{ github.event.inputs.hours }}" >> $GITHUB_OUTPUT
            echo "üìå Modo manual: ${{ github.event.inputs.mode }}"
          else
            HOUR=$(date -u +%H)
            MINUTE=$(date -u +%M)
            DAY=$(date -u +%u)  # 1-7 (seg-dom)
            
            # 23h UTC = resumo di√°rio
            if [[ "$HOUR" == "23" && "$MINUTE" -lt "15" ]]; then
              echo "mode=summary" >> $GITHUB_OUTPUT
              echo "üìä Hor√°rio do resumo di√°rio"
            # 10h UTC (7h BRT) em dias √∫teis = pauta da C√¢mara
            elif [[ "$HOUR" == "10" && "$MINUTE" -lt "15" && "$DAY" -le "5" ]]; then
              echo "mode=pauta" >> $GITHUB_OUTPUT
              echo "üèõÔ∏è Hor√°rio da pauta da C√¢mara"
            else
              echo "mode=normal" >> $GITHUB_OUTPUT
              echo "hours=8" >> $GITHUB_OUTPUT
              echo "üì∞ Execu√ß√£o normal"
            fi
          fi

      - name: Run bot (normal)
        id: bot
        if: steps.mode.outputs.mode == 'normal'
        continue-on-error: true
        env:
          TELEGRAM_BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
          TELEGRAM_CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}
        run: |
          python telegram_news_bot.py --hours ${{ steps.mode.outputs.hours }}

      - name: Run bot (daily summary)
        id: summary
        if: steps.mode.outputs.mode == 'summary'
        continue-on-error: true
        env:
          TELEGRAM_BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
          TELEGRAM_CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}
        run: |
          python telegram_news_bot.py --summary

      - name: Run bot (pauta C√¢mara)
        id: pauta
        if: steps.mode.outputs.mode == 'pauta'
        continue-on-error: true
        env:
          TELEGRAM_BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
          TELEGRAM_CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}
        run: |
          python telegram_news_bot.py --pauta

      - name: Notify failure
        if: steps.bot.outcome == 'failure' || steps.summary.outcome == 'failure' || steps.pauta.outcome == 'failure'
        env:
          TELEGRAM_BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
          TELEGRAM_CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}
        run: |
          curl -s -X POST "https://api.telegram.org/bot${TELEGRAM_BOT_TOKEN}/sendMessage" \
            -d "chat_id=${TELEGRAM_CHAT_ID}" \
            -d "text=‚ö†Ô∏è <b>Newsbot falhou!</b>%0A%0AMode: ${{ steps.mode.outputs.mode }}%0Aüîó <a href=\"https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}\">Ver logs</a>" \
            -d "parse_mode=HTML" \
            -d "disable_web_page_preview=true"

      - name: Commit state (db/xlsx)
        run: |
          git config user.name "newsbot"
          git config user.email "newsbot@users.noreply.github.com"

          git add sent_items.db historico_news.xlsx || true

          if git diff --cached --quiet; then
            echo "‚úÖ Nenhuma altera√ß√£o"
            exit 0
          fi

          git commit -m "chore: update newsbot state [skip ci]"
          git push

      - name: Fail job if bot failed
        if: steps.bot.outcome == 'failure' || steps.summary.outcome == 'failure' || steps.pauta.outcome == 'failure'
        run: exit 1
