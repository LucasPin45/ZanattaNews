name: Telegram News Bot

on:
  schedule:
    - cron: "*/15 * * * *"   # A cada 15 minutos (UTC)
    - cron: "0 23 * * *"     # Resumo di√°rio √†s 20h BRT (23h UTC)
  workflow_dispatch:
    inputs:
      send_summary:
        description: 'Enviar apenas resumo di√°rio'
        required: false
        default: 'false'
        type: boolean

concurrency:
  group: newsbot
  cancel-in-progress: true

permissions:
  contents: write

jobs:
  run-bot:
    runs-on: ubuntu-latest
    timeout-minutes: 10

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"
          cache: 'pip'  # Cache de depend√™ncias

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: Determine run mode
        id: mode
        run: |
          # Verifica se √© hor√°rio do resumo di√°rio (23h UTC = 20h BRT)
          HOUR=$(date -u +%H)
          MINUTE=$(date -u +%M)
          
          if [[ "${{ github.event.inputs.send_summary }}" == "true" ]]; then
            echo "mode=summary" >> $GITHUB_OUTPUT
          elif [[ "$HOUR" == "23" && "$MINUTE" -lt "15" ]]; then
            echo "mode=summary" >> $GITHUB_OUTPUT
          else
            echo "mode=normal" >> $GITHUB_OUTPUT
          fi

      - name: Run bot (normal)
        id: bot
        if: steps.mode.outputs.mode == 'normal'
        continue-on-error: true
        env:
          TELEGRAM_BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
          TELEGRAM_CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}
        run: |
          python telegram_news_bot.py --hours 8

      - name: Run bot (daily summary)
        if: steps.mode.outputs.mode == 'summary'
        env:
          TELEGRAM_BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
          TELEGRAM_CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}
        run: |
          python telegram_news_bot.py --summary

      - name: Notify failure
        if: steps.bot.outcome == 'failure'
        env:
          TELEGRAM_BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
          TELEGRAM_CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}
        run: |
          curl -s -X POST "https://api.telegram.org/bot${TELEGRAM_BOT_TOKEN}/sendMessage" \
            -d "chat_id=${TELEGRAM_CHAT_ID}" \
            -d "text=‚ö†Ô∏è <b>Newsbot falhou!</b>%0A%0Aüîó <a href=\"https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}\">Ver logs</a>" \
            -d "parse_mode=HTML" \
            -d "disable_web_page_preview=true"

      - name: Commit state (db/xlsx)
        run: |
          git config user.name "newsbot"
          git config user.email "newsbot@users.noreply.github.com"

          git add sent_items.db historico_news.xlsx || true

          if git diff --cached --quiet; then
            echo "No changes to commit."
            exit 0
          fi

          git commit -m "chore: update newsbot state [skip ci]"
          git push

      - name: Fail job if bot failed
        if: steps.bot.outcome == 'failure'
        run: exit 1
